# マップレイアウト変更の具体例

## 📋 目次

1. [初回セットアップ](#1-初回セットアップ)
2. [例1: 通路の幅を変更する](#例1-通路の幅を変更する)
3. [例2: 新しい通路を追加する](#例2-新しい通路を追加する)
4. [例3: エントランスの位置を変更する](#例3-エントランスの位置を変更する)
5. [例4: 次回の展示会用に新しいレイアウトを作成](#例4-次回の展示会用に新しいレイアウトを作成)
6. [例5: 会場の色を変更する](#例5-会場の色を変更する)

---

## 1. 初回セットアップ

### ステップ1: アプリから現在のレイアウトを保存

1. アプリを起動
2. 会場混雑状況画面を開く
3. 右上の「︙」メニュー → **「マップレイアウト初期化」**をタップ
4. 「マップレイアウトの初期化が完了しました！」と表示されるのを確認

### ステップ2: Firebaseコンソールでデータを確認

1. Firebaseコンソール (https://console.firebase.google.com/) を開く
2. プロジェクトを選択
3. 左メニューから「Firestore Database」をクリック
4. 以下のコレクションが作成されていることを確認:
   - `event_layouts` (1件: event_2025_default)
   - `map_elements` (10件: element_0 ~ element_9)

---

## 例1: 通路の幅を変更する

**シナリオ**: 横通路1を広くしたい（30px → 50pxに変更）

### 手順

1. Firebaseコンソールで「Firestore Database」を開く
2. `map_elements` コレクションをクリック
3. `element_4` をクリック（横通路1の要素）

現在のデータ:
```javascript
{
  eventId: "event_2025_default",
  type: "corridor",
  shape: "rect",
  x: 20,
  y: 80,
  width: 660,
  height: 30,      // ← これを変更
  color: "#EEEEEE",
  label: "横通路1",
  zIndex: 1
}
```

4. `height` フィールドの値を `30` → `50` に変更
5. 「保存」をクリック

### 結果

- 横通路1の幅が広くなります
- アプリを再起動すると新しいレイアウトで表示されます

---

## 例2: 新しい通路を追加する

**シナリオ**: 会場の下部に新しい横通路を追加したい

### 手順

1. `map_elements` コレクションを開く
2. 「ドキュメントを追加」をクリック
3. ドキュメントID: `element_10` と入力
4. 以下のフィールドを追加:

| フィールド名 | 型 | 値 |
|------------|-----|-----|
| eventId | string | event_2025_default |
| type | string | corridor |
| shape | string | rect |
| x | number | 20 |
| y | number | 440 |
| width | number | 660 |
| height | number | 30 |
| color | string | #EEEEEE |
| label | string | 横通路4 |
| zIndex | number | 1 |

5. 「保存」をクリック

### 結果

- 会場の下部（Y座標440）に新しい通路が表示されます
- 既存の通路と同じスタイル（グレー、幅30px）で描画されます

---

## 例3: エントランスの位置を変更する

**シナリオ**: 正面エントランスを左に移動したい

### 手順

1. `map_elements` コレクションを開く
2. `element_2` をクリック（正面エントランス）

現在のデータ:
```javascript
{
  eventId: "event_2025_default",
  type: "entrance",
  shape: "rect",
  x: 80,           // ← これを変更
  y: 20,
  width: 40,
  height: 20,
  color: "#A1887F",
  label: "正面エントランス",
  zIndex: 2
}
```

3. `x` フィールドの値を `80` → `50` に変更
4. 「保存」をクリック

### 結果

- 正面エントランスが左に30px移動します

---

## 例4: 次回の展示会用に新しいレイアウトを作成

**シナリオ**: 2025年夏季展示会用の新しいレイアウトを作成

### パート1: 展示会設定を作成

1. `event_layouts` コレクションを開く
2. 「ドキュメントを追加」をクリック
3. ドキュメントID: `event_2025_summer` と入力
4. 以下のフィールドを追加:

| フィールド名 | 型 | 値 |
|------------|-----|-----|
| eventName | string | 2025年夏季展示会 |
| eventDate | string | 2025-07-15 |
| mapWidth | number | 700 |
| mapHeight | number | 500 |
| backgroundColor | string | #FAFAFA |
| gridSize | number | 10 |
| active | boolean | false |
| createdAt | timestamp | (自動) |

5. 「保存」をクリック

### パート2: マップ要素をコピーして編集

既存の要素を複製して、新しいイベント用に編集します。

**例: 横通路1をコピー**

1. `map_elements` コレクションで `element_4` を開く
2. 全てのフィールドをコピー
3. 「ドキュメントを追加」で新しいドキュメントを作成
4. ドキュメントID: `element_summer_1`
5. コピーしたフィールドを貼り付け
6. `eventId` を `event_2025_summer` に変更
7. 必要に応じて他のフィールド（x, y, width, heightなど）を調整
8. 「保存」をクリック

### パート3: 新しいレイアウトをアクティブにする

準備ができたら、新しいレイアウトに切り替えます。

1. `event_layouts` コレクションを開く
2. `event_2025_default` を開き、`active` を `false` に変更
3. `event_2025_summer` を開き、`active` を `true` に変更
4. アプリを再起動

### 結果

- 新しい展示会のレイアウトが表示されます
- 古い展示会のデータは保持されているので、いつでも戻せます

---

## 例5: 会場の色を変更する

**シナリオ**: 通路の色をグレーから薄い青に変更したい

### 手順

1. `map_elements` コレクションを開く
2. 通路の要素（element_4, element_5, element_6など）を1つずつ開く
3. `color` フィールドの値を変更:
   - 変更前: `#EEEEEE` (グレー)
   - 変更後: `#E3F2FD` (薄い青)
4. 各要素で「保存」をクリック

### より効率的な方法（複数要素を一度に変更）

残念ながら、Firebaseコンソールでは複数ドキュメントの一括更新はできません。
多くの要素を変更する場合は、以下のいずれかの方法を推奨します:

#### 方法A: Firebaseコンソールで1つずつ変更（確実）
#### 方法B: プログラムで一括更新（上級者向け）

以下のコードを実行（アプリに追加するか、スクリプトとして実行）:

```dart
// FirebaseServiceに以下のメソッドを追加
Future<void> updateCorridorColors(String eventId, String newColor) async {
  final elements = await _firestore
      .collection('map_elements')
      .where('eventId', isEqualTo: eventId)
      .where('type', isEqualTo: 'corridor')
      .get();
  
  final batch = _firestore.batch();
  for (final doc in elements.docs) {
    batch.update(doc.reference, {'color': newColor});
  }
  await batch.commit();
  print('通路の色を更新しました: $newColor');
}
```

---

## 🎨 色の見本

よく使う色のカラーコード:

### グレー系
- `#FAFAFA` - 明るいグレー（背景）
- `#EEEEEE` - 薄いグレー（通路）
- `#BDBDBD` - グレー（壁）
- `#757575` - 濃いグレー

### 青系
- `#E3F2FD` - 極薄い青
- `#BBDEFB` - 薄い青
- `#2196F3` - 青
- `#1976D2` - 濃い青

### 緑系
- `#E8F5E9` - 極薄い緑
- `#C8E6C9` - 薄い緑
- `#4CAF50` - 緑
- `#388E3C` - 濃い緑

### 茶色系
- `#EFEBE9` - 極薄い茶色
- `#D7CCC8` - 薄い茶色
- `#A1887F` - 茶色（エントランス）
- `#795548` - 濃い茶色

---

## 💡 Tips

### 座標の計算方法

マップのサイズは `700 × 500` です。

#### 中央に配置したい場合
- X座標の中央: `350` (700 ÷ 2)
- Y座標の中央: `250` (500 ÷ 2)

#### 要素を中央に配置する例（幅100pxの要素）
- X座標: `300` (350 - 100÷2)
- Y座標: `225` (250 - 50÷2)

### 等間隔に配置する場合

3本の縦通路を等間隔に配置する例:
- 通路の幅: 30px
- マップの幅: 700px
- 左右のマージン: 20px

計算:
- 使用可能幅: 700 - 40 = 660px
- 通路の合計幅: 30 × 3 = 90px
- 残りの幅: 660 - 90 = 570px
- 間隔: 570 ÷ 4 = 142.5px

配置:
- 通路1: x = 20 + 142.5 = 162.5
- 通路2: x = 162.5 + 30 + 142.5 = 335
- 通路3: x = 335 + 30 + 142.5 = 507.5

### 描画順序（zIndex）の使い方

小さい値が先に描画されます（下レイヤー）:

```
0 - 背景
1 - 通路、壁
2 - エントランス、装飾
3 - ブース（自動）
4 - ヒートマップ（自動）
5 - ルート表示（自動）
```

重なる要素がある場合、上に表示したい要素のzIndexを大きくします。

---

## 🚨 よくある問題と解決方法

### Q1: 変更が反映されない

**解決方法**:
1. アプリを完全に再起動（タスクキルしてから起動）
2. Firebaseで `active: true` の展示会が1つだけか確認
3. ブラウザのキャッシュをクリア（Web版の場合）

### Q2: 要素が表示されない

**確認ポイント**:
- `eventId` が現在アクティブな展示会IDと一致しているか
- 座標が範囲内（x: 0-700, y: 0-500）にあるか
- `zIndex` が適切か（0-2の範囲推奨）

### Q3: 色が変わらない

**確認ポイント**:
- カラーコードが `#` で始まっているか
- 16進数が6桁（例: `#EEEEEE`）になっているか
- 大文字小文字は区別されない（`#eeeeee` でも可）

### Q4: 通路が表示されない場所がある

**解決方法**:
- `zIndex` を確認（背景の上に表示されるよう、1以上に設定）
- 色が背景と同じになっていないか確認
- 幅・高さが0になっていないか確認

---

## 📞 サポート

さらにサポートが必要な場合は、以下の情報を含めてお問い合わせください:

- 実行したい変更内容
- 現在の設定値
- エラーメッセージ（あれば）
- スクリーンショット（あれば）

